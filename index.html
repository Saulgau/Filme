<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filmportal</title>
    <div style="color: red; font-weight: bold; border: 2px solid red; padding: 10px; background-color: #ffe6e6;">
    Diese Seite bietet nur Filme in guter Qualität an. Videos, die im Kino aufgenommen wurden, werden hier nicht angeboten. Daher kann es zu längeren Wartezeiten kommen, bis die Filme hier erscheinen.
</div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center mb-6">Filmportal</h1>
            <div class="flex justify-center items-center space-x-4 flex-wrap">
                <input type="text" id="search-query" placeholder="Filmtitel suchen..." class="p-2 rounded-full border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 flex-grow max-w-md">
                <button onclick="searchMovies()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                    Suchen
                </button>
                <button onclick="toggleDarkMode()" id="dark-mode-toggle" class="bg-gray-200 dark:bg-gray-700 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
        </header>
        <main>
            <div id="movie-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Filme werden durch JavaScript hier eingefügt -->
            </div>
        </main>
    </div>

    <script>
        // Filmliste
        const movies = [
            {
                title: "Deadpool & Wolverine",
                image: "https://lumiere-a.akamaihd.net/v1/images/image_9b066416.jpeg",
                link: "LINK_ZU_DEADPOOL_WOLVERINE"
            },
            {
                title: "Alles steht Kopf 2",
                image: "https://de.web.img3.acsta.net/img/44/7d/447d0ad9c57e73e5c17b3e07c37b97c8.jpg",
                link: "https://3jtpuy07im.swiftload.io/serve/3/obxbvt06dz8/QlaH3NXuOEv2RjdXVcDEfQ/1725191511/obxbvt06dz8//master.m3u8"
            },
            {
                title: "Chantal im Märchenland",
                image: "https://de.web.img3.acsta.net/pictures/24/03/01/19/29/3351541.jpg",
                link: "https://3jtpuy07im.swiftload.io/serve/3/e3eq2m4qz9t/reBKNUZNitBLrtdkFPcBEA/1725292119/e3eq2m4qz9t//master.m3u8"
            },
            {
                title: "Ich - Einfach Unverbesserlich 4",
                image: "https://cdn.kinocheck.com/i/b238psiahp.jpg",
                link: "https://3jtpuy07im.swiftload.io/serve/3/kfvoc2p3auf/OFRNicTzpYI7Zhl0pRoHWQ/1725129465/kfvoc2p3auf//master.m3u8"
            }
        ];

        // Token abrufen
        async function fetchToken() {
            const tokenEndpoint = 'https://example.com/get-token';
            try {
                const response = await fetch(tokenEndpoint);
                if (!response.ok) throw new Error('Token fetch failed');
                const data = await response.json();
                return data.token;
            } catch (error) {
                console.error('Error fetching token:', error);
                return null;
            }
        }

        // Film-Links aktualisieren
        async function updateMovieLinks() {
            const token = await fetchToken();
            if (!token) {
                console.warn('Token konnte nicht abgerufen werden. Links bleiben unverändert.');
                return;
            }
            movies.forEach(movie => {
                const separator = movie.link.includes('?') ? '&' : '?';
                movie.link = `token=`;
            });
        }

        // Filme anzeigen
        function displayMovies(movieList) {
            const movieListElement = document.getElementById('movie-list');
            movieListElement.innerHTML = movieList.map(movie => `
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden transition-transform duration-300 ease-in-out transform hover:-translate-y-1 hover:shadow-lg">
        <img src="${movie.image}" alt="${movie.title}" class="w-full h-64 object-cover" onerror="this.src='https://via.placeholder.com/400x300?text=Bild+nicht+verfügbar'">
        <div class="p-4">
            <h2 class="text-xl font-semibold mb-2">${movie.title}</h2>
            <button onclick="openPlayer('${movie.link}', '${movie.title}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300 ease-in-out w-full">
                Film ansehen
            </button>
        </div>
    </div>
`).join('');
        }

        // Player öffnen
        function openPlayer(m3u8Url, title) {
            const playerWindow = window.open("", "_blank");
            playerWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Filmwiedergabe</title>
                    <style>
                        body { margin: 0; background-color: #000; display: flex; justify-content: center; align-items: center; height: 100vh; }
                        #videoPlayer { width: 100%; max-width: 1280px; height: auto; max-height: 90vh; }
                    </style>
                </head>
                <body>
                    <video id="videoPlayer" controls></video>
                    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"><\/script>
                    <script>
                        const video = document.getElementById('videoPlayer');
                        const m3u8Url = '${m3u8Url}';
                        const cookieName = 'videoTime_' + encodeURIComponent('${title}');
                        
                        // Zeit aus dem Cookie laden
                        const savedTime = parseFloat(getCookie(cookieName)) || 0;

                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(m3u8Url);
                            hls.attachMedia(video);
                            hls.on(Hls.Events.MANIFEST_PARSED, function () {
                                video.currentTime = savedTime;
                                video.play();
                            });
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = m3u8Url;
                            video.addEventListener('loadedmetadata', function () {
                                video.currentTime = savedTime;
                                video.play();
                            });
                        }

                        // Zeit beim Schließen des Fensters speichern
                        window.addEventListener('beforeunload', function () {
                            setCookie(cookieName, video.currentTime, 365);
                        });

                        function getCookie(name) {
                            const value = "; " + document.cookie;
                            const parts = value.split("; " + name + "=");
                            if (parts.length === 2) return parts.pop().split(";").shift();
                        }

                        function setCookie(name, value, days) {
                            const d = new Date();
                            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                            const expires = "expires=" + d.toUTCString();
                            document.cookie = name + "=" + value + ";" + expires + ";path=/";
                        }
                    <\/script>
                </body>
                </html>
            `);
        }

        // Filme suchen
        function searchMovies() {
            const query = document.getElementById('search-query').value.toLowerCase();
            const filteredMovies = movies.filter(movie => 
                movie.title.toLowerCase().includes(query)
            );
            displayMovies(filteredMovies);
        }

        // Dark Mode umschalten
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
        }

        // Beim Laden der Seite den gespeicherten Modus anwenden
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark');
        }

        // Initialisierung
        async function init() {
            await updateMovieLinks();
            displayMovies(movies);
        }

        // Starten der Anwendung
        init();
    </script>
</body>
</html>
